#define Direction 8
#define LED_pin 6
#define Motor 9
#define FG_Pin 2

#define ONE_ROUND_PULSE 18

volatile uint16_t counter = 0;
bool oneRoundDone = false;
unsigned long lastStopTime = 0;  // è®°å½•ä¸Šæ¬¡åœæ­¢çš„æ—¶é—´
const unsigned long RESTART_DELAY = 5000;  // åœæ­¢åå»¶æ—¶5ç§’å†å¯åŠ¨

void counterISR() {
  counter++;
}

void setup() {
  Serial.begin(115200);
  delay(3000);  // ä¸Šç”µå»¶è¿Ÿ

  pinMode(FG_Pin, INPUT_PULLUP);
  pinMode(Motor, OUTPUT);
  pinMode(Direction, OUTPUT);
  pinMode(LED_pin, OUTPUT);

  digitalWrite(LED_pin, LOW);
  digitalWrite(Direction, HIGH);
  counter = 0;

  attachInterrupt(digitalPinToInterrupt(FG_Pin), counterISR, RISING);
  delay(500);
  Serial.println(counter);

  analogWrite(Motor, 180);  // å¯åŠ¨ç”µæœº
}

void loop() {
  if (!oneRoundDone && counter >= ONE_ROUND_PULSE) {
    analogWrite(Motor, 0);               // åœæ­¢ç”µæœº
    Serial.println(counter);
    digitalWrite(LED_pin, HIGH);         // ç¯äº®
    detachInterrupt(digitalPinToInterrupt(FG_Pin));
    oneRoundDone = true;
    lastStopTime = millis();             // è®°å½•åœæ­¢æ—¶é—´
    Serial.println("âœ… One Round Done");
  }

  // â±ï¸ åˆ°æ—¶é—´é‡æ–°å¯åŠ¨ç”µæœº
  if (oneRoundDone && millis() - lastStopTime >= RESTART_DELAY) {
    counter = 0;
    oneRoundDone = false;
    attachInterrupt(digitalPinToInterrupt(FG_Pin), counterISR, RISING);
    analogWrite(Motor, 180);            // é‡å¯ç”µæœº
    digitalWrite(LED_pin, LOW);         // ç¯ç­
    Serial.println("ğŸ” Restart Motor");
  }
}
